# Stage 1: Build the Go binary
FROM registry.access.redhat.com/ubi10/go-toolset:10.0 AS builder

# Use the standard non-root directory provided by UBI images
WORKDIR /opt/app-root/src

# Copy dependency files and download them
COPY --chown=1001:0 go.mod go.sum ./
RUN go mod download

# Copy source code with correct ownership
COPY --chown=1001:0 . .

# Build the binary
RUN go build -o guestbook-api main.go

# Stage 2: Final minimal image
FROM registry.access.redhat.com/ubi10-minimal:10.0
WORKDIR /app

# Copy the binary from the builder
COPY --from=builder /opt/app-root/src/guestbook-api .

# Set non-root user for the final image (standard for OpenShift)
USER 1001

# The binary needs to know where the DBs are
ENV DB_HOST="" \
    DB_PORT="" \
    DB_USER="" \
    DB_PASSWORD="" \
    DB_NAME="" \
    REDIS_HOST="" \
    REDIS_PORT="" \
    REDIS_PASSWORD="" \
    PORT=""

EXPOSE 8080
CMD ["./guestbook-api"]
